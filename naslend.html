<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
        crossorigin="anonymous">

    <style>
        .content {
            margin: 5em;
        }

        .btn {
            width: 100%
        }

        .title {
            text-align: left;
            margin-bottom: 0
        }
    </style>

    <title>NasLend</title>
</head>

<body>
    <h1 align="center" style="margin-top: 1em" onclick="show('start')">星云贷 (<span id=net-type></span>)</h1>
    <div class="content start">
        <div class="form-group row">
            <div class="col">
                <h4 class=title>当前的借贷列表</h4>
            </div>
        </div>
        <div class="form-group row">
            <div class="col">
                <div class="list-group" id="lend_ids">
                </div>
            </div>
        </div>
    </div>

    <div class="fade modal help" data-backdrop=static>
        <div class=modal-dialog>
            <div class=modal-content>
                <div class=modal-body>
                    TBA
                </div>
            </div>
        </div>
    </div>

    <div class="content guar">
        <div class="form-group row">
            <div class=col>
                <h4 class=title>为新的借贷提供担保</h4>
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <label>担保金额</label>
                <input class=form-control type=text id=guarantee_amount value="0.01">
            </div>
            <div class=col>
                <label>最低利率</label>
                <input class=form-control type=text id=min_rate value="1.1">
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <label>寻找出资人时限（块）</label>
                <input class=form-control type=text id=response_duration value="100">
            </div>
            <div class=col>
                <label>借贷期限（块)</label>
                <input class=form-control type=text id=lend_duration value="100">
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <label>借贷case编号</label>
                <input class="form-control case_id" type=text>
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <button id=guarantee-btn class="btn btn-primary">提供担保</button>
            </div>
        </div>
    </div>


    <div class="content lend">
        <div class="form-group row">
            <div class=col>
                <h4 class=title>为借贷
                    <span class='lend-id'></span>提供资金， 担保人是
                    <span class='guar-name'></span>，担保资金
                    <span class='guar-deposit'></span>NAS</h4>
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <label>提供金额（不低于
                    <span class='guar-deposit'></span>NAS）</label>
                <input class=form-control type=text id=lend_amount value="0.2">
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <label>最高利率（不低于
                    <span class='min-rate'></span>%）</label>
                <input class=form-control type=text id=max_rate value="2">
            </div>
            <div class=col>
                <label>拍卖期限</label>
                <input class=form-control type=text id=auction_duration value="100">
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <button id=lend_btn class="btn btn-primary">提供贷款</button>
            </div>
        </div>
    </div>


    <div class="content bid">
        <div id="form-group row">
            <div class=col>
                <h4 class=title>
                    <p>竞拍贷款
                        <span class='lend-id'></span>，金额是
                        <span class='lend-amount'></span>NAS，您当前的利率是
                        <span class=cur-rate></span>%</p>
                    <p>需要在
                        <span class=last-block></span>块前竞拍</p>
                </h4>
                <div align=center id="rate-chart" style="height: 500px"></div>
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <button id=bid_btn class="btn btn-primary">竞拍</button>
            </div>
        </div>
    </div>

    <div class="content pay">
        <div id="form-group row">
            <div class=col>
                <h4 class=title>
                    <p>在未来
                        <span class="count-down"></span>块之内，偿还贷款编号
                        <span class='lend-id'></span>，偿还
                        <span class='pay-amount'></span>NAS。
                    </p>
                    <p>
                        如果您要偿还贷款，请确定您的地址是
                        <span class="pay-address"></span>，否则会偿还失败。
                    </p>
                </h4>
            </div>
        </div>
        <div class="form-group row">
            <div class=col>
                <button id=pay_btn class="btn btn-primary">偿还</button>
            </div>
        </div>
    </div>

    <div class="content finished">
        <div id="form-group row">
            <div class=col>
                <h4 class=title>
                    历史借贷详情
                </h4>
            </div>
        </div>
        <div class="form-group row">
            <div class=col>
                <p>
                    借贷
                    <span id='lend-result'></span>，借贷的担保人是
                    <span id='guarantor'></span>，担保金额是
                    <span id='guar-amount'></span> NAS，资金提供人是
                    <span id='lend-account'></span>，借贷金额是
                    <span id='lend-amount'></span> NAS，借贷利率是
                    <span id='interest'></span>%，借款人是
                    <span id='borrower'></span>。
                </p>
            </div>
        </div>
    </div>

    <span class="refresh">
    </span>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
        crossorigin="anonymous"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-gl/echarts-gl.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-stat/ecStat.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/dataTool.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/world.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ZUONbpqGBsYGXNIYHicvbAbM"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/simplex.js"></script>
    <script src=lib/nebulas.js></script>
    <script src=lib/nebPay.js></script>

    <script>
        function show_bid_rate(min_block, max_block, min_rate, max_rate, cur_block, cur_rate) {
            var dom = document.getElementById("rate-chart");
            var myChart = echarts.init(dom);
            var app = {};
            option = null;

            option = {
                xAxis: {
                    type: 'value',
                    data: [min_block, max_block],
                    axisLabel: {
                        formatter: function (val) {
                            return 'block# ' + val;
                        }
                    },
                    scale: true
                },
                yAxis: {
                    type: 'value',
                    data: [min_rate, max_rate],
                    axisLabel: {
                        formatter: function (val) {
                            return 100 * val + "%";
                        }
                    },
                    scale: true
                },
                series: [{
                        data: [
                            [min_block, max_rate],
                            [cur_block, cur_rate]
                        ],
                        type: 'line',
                        areaStyle: {}
                    },
                    {
                        data: [
                            [cur_block, cur_rate],
                            [max_block, min_rate]
                        ],
                        type: 'line',
                        markLine: {
                            data: [{
                                type: 'max',
                                name: '当前利率'
                            }]
                        }
                    }
                ]
            };
            if (option && typeof option === "object") {
                myChart.setOption(option, true);
            }

            $('#cur-block').text(cur_block);
            $('#cur-rate').text(cur_rate * 100);
        }
    </script>

    <script>
        "use strict";
        var TIMER = null;
        var COUNT_DOWN = 8;

        var CONTRACT_ADDR = "n1oRdNatiaHiRuxXRdKtDKmL4qGC4DAvhsD";
        var NET_TYPE = 'TEST';

        var NET_URL = null;
        var NET_ADDR = null;

        var LEND_ID = null;

        var nebulas = require("nebulas"),
            neb = new nebulas.Neb(),
            globalParams = {
                account: null
            };

        if (NET_TYPE == 'MAIN') {
            NET_URL = 'https://mainnet.nebulas.io/v1/user/call';
            NET_ADDR = 'n1YeD6SCiSNxjQ1CEUhSpThNxPU77mvB1sp';

            neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));

            $('#net-type').text('主网');
        } else {
            NET_URL = 'https://testnet.nebulas.io/v1/user/call';
            NET_ADDR = 'n1cNkcUumVmt6CHjYhgTECZHnm3nGDzkWfx';

            neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));

            $('#net-type').text('测试网');
        }

        $("#guarantee-btn").on("click", onGuar);
        $("#lend_btn").on("click", onLend);
        $("#bid_btn").on("click", onBid);
        $("#pay_btn").on("click", onPay);


        var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
        var nebPay = new NebPay();
        var serialNumber;

        function show_info(msg) {
            if (msg.txhash) {
                alert("交易发送成功");
            } else {
                alert(msg.toString() || "交易发送成功");
            }
        }

        window.addEventListener('message', function (e) {
            console.log("message received, msg.data: " + JSON.stringify(e.data));
            if (!!e.data.data.txhash) {
                if ($(".modal.tips").is(':visible')) {
                    $(".modal.tips").modal('toggle');
                }
                console.log("交易哈希：" + JSON.stringify(e.data.data.txhash, null, '\t'));
                show('start');
            }
        });

        //show('start');

        var CUR_SCENE = 'start';

        function show(_which) {
            var which = _which;

            CUR_SCENE = which;

            $(".start").hide();
            $(".guar").hide();
            $(".lend").hide();
            $(".bid").hide();
            $(".pay").hide();
            $(".finished").hide();

            $("." + which).show();


            render(which);
        }



        COUNT_DOWN = 8;
        TIMER = setInterval(function () {
            COUNT_DOWN -= 1;
            if (COUNT_DOWN == 0) {
                console.log(CUR_SCENE)
                render(CUR_SCENE);
                COUNT_DOWN = 8;
            }
            $(".refresh").text(COUNT_DOWN);
        }, 1000);



        function setID(id) {
            LEND_ID = id;
        }

        function show_guar(res) {
            var id = LEND_ID;
            $('.case_id').val(id);
        }

        function onGuar() {
            var _value = parseFloat($("#guarantee_amount").val());
            var _args = "";
            var id = $(".case_id").val();
            var min_interest_rate = parseFloat($("#min_rate").val());
            var response_duration = parseInt($("#response_duration").val());
            var lend_duration = parseInt($("#lend_duration").val());

            var args = JSON.stringify([id, min_interest_rate, response_duration, lend_duration]);
            var _to_addr = CONTRACT_ADDR;

            alert("注意：您将要向合约地址转账来提供担保。");
            nebPay.call(_to_addr, _value, "guarantee", args, {    //使用nebpay的call接口去调用合约,
                listener: show_info        //设置listener, 处理交易返回信息
            });
        }

        function show_lend(res) {
            $('.lend-id').text(LEND_ID);
            $('.guar-name').text(res['guarantor']);
            $('.guar-deposit').text(res['min_deposit'] / 1e18);

            $('.min-rate').text(res['min_interest_rate'] * 100);

            $('#max_rate').val(parseFloat(res['min_interest_rate']) + 0.1);
            $('#lend_amount').val(res['min_deposit'] / 1e18);

        }

        function onLend() {
            var _value = parseFloat($("#lend_amount").val());
            var _args = "";

            var id = LEND_ID;
            var max_interest_rate = parseFloat($("#max_rate").val());
            var bid_duration = parseInt($("#auction_duration").val());

            var args = JSON.stringify([id, max_interest_rate, bid_duration]);
            var _to_addr = CONTRACT_ADDR;

            alert("注意：您将向合约地址转账来提供借贷。")
            nebPay.call(_to_addr, _value, "lend", args, {    //使用nebpay的call接口去调用合约,
                listener: show_info        //设置listener, 处理交易返回信息
            });
        }

        function show_bid(res) {
            $('.lend-id').text(LEND_ID);
            $('.lend-amount').text(res['real_deposit'] / 1e18);
            $('.cur-rate').text(res['current_rate'] * 100);
            $('.last-block').text(res['expiration']);

            var min_block = res['block'] - (res['max_interest_rate'] - res['current_rate']) * (res['expiration'] -
                res['block']) / (
                res['current_rate'] - res['min_interest_rate']);

            show_bid_rate(min_block, res['expiration'], parseFloat(res['min_interest_rate']), res[
                'max_interest_rate'], res['block'], res['current_rate']);
        }

        function onBid() {
            let _value = "0";
            var _args = "";


            let id = LEND_ID;
            let bid_rate = parseFloat($('.cur-rate').text()) / 100;

            let args = JSON.stringify([id, bid_rate]);
            var _to_addr = CONTRACT_ADDR;

            nebPay.call(_to_addr, _value, "bid", args, {    //使用nebpay的call接口去调用合约,
                listener: show_info        //设置listener, 处理交易返回信息
            });
        }

        function show_pay(res) {
            console.log(res);
            $('.pay-address').text(res['borrower']);
            $('.count-down').text(parseInt(res['expiration']) - parseInt(res['block']));
            $('.lend-id').text(LEND_ID);
            $('.pay-amount').text(res['real_deposit'] * res['interest_rate'] / 1e18);
        }

        function onPay() {
            let _value = parseFloat($('.pay-amount').text());
            var _args = "";


            let id = LEND_ID;
            let args = JSON.stringify([id]);
            var _to_addr = CONTRACT_ADDR;

            alert("注意：您将向合约地址转账来偿还借贷。")
            nebPay.call(_to_addr, _value, "pay_back", args, {    //使用nebpay的call接口去调用合约,
                listener: show_info        //设置listener, 处理交易返回信息
            });
        }

        function show_finished(res) {
            if (res['state'] == 3) {
                $('#lend-result').text('成功');
            } else if (res['state'] == 4) {
                $('#lend-result').text('失败');
            }

            $('#guarantor').text(res['guarantor']);
            $('#guarantor').text(res['guarantor']);
            $('#guar-amount').text(res['min_deposit'] / 1e18);
            $('#lend-account').text(res['lender']);
            $('#lend-amount').text(res['real_deposit'] / 1e18);
            $('#interest').text(res['interest_rate'] * 100);
            $('#borrower').text(res['borrower']);
        }


        function render(_which) {

            var which = _which;

            if (which == 'start') {
                refresh_lend_ids();
            } else {
                var from = NET_ADDR;
                var _to_addr = CONTRACT_ADDR;
                var _value = "0";
                var gas_price = '1000000';
                var gas_limit = '200000000';
                var _args = JSON.stringify([LEND_ID]);
                var contract = {
                    "function": "detail",
                    "args": _args
                }

                console.log(contract);

                neb.api.call(from, _to_addr, _value, '0', gas_price, gas_limit, contract).then(function(resp){
                    var res = JSON.parse(JSON.parse(resp['result']));
                    console.log(res);

                    if (which == 'guar') {
                        show_guar(res);
                    } else if (which == 'lend') {
                        show_lend(res);
                    } else if (which == 'bid') {
                        show_bid(res);
                    } else if (which == 'pay') {
                        show_pay(res);
                    } else if (which == 'finished') {
                        show_finished(res);
                    }
                });
            }
        }

        function refresh_lend_ids() {
            var from = NET_ADDR;
            var _to_addr = CONTRACT_ADDR;
            var _value = "0";
            var gas_price = '1000000';
            var gas_limit = '200000000';
            var _args = "";
            var contract = {
                "function": "get_ids",
                "args": _args
            }

            console.log(contract);

            neb.api.call(from, _to_addr, _value, '0', gas_price, gas_limit, contract).then(function(resp){
                var str = "";
                console.log(resp['result']);
                var res = JSON.parse(JSON.parse(resp['result']));
                /*res = {
                    'x': 0,
                    'a': 1,
                    'b': 2,
                    'c': 3,
                    'd': 4
                };*/
                console.log(res);
                for (var id in res) {
                    var state = res[id];

                    console.log(id, state);

                    if (state == '0') {
                        str +=
                            "<a onclick=\" setID('" + id +
                            "'); show('lend');\"  class='list-group-item list-group-item-action list-group-item-primary'> 编号" +
                            id + " (等待储蓄)" + "</a>"
                    } else if (state == '1') {
                        str +=
                            "<a onclick=\" setID('" + id +
                            "'); show('bid')\" class='list-group-item list-group-item-action list-group-item-warning'> 编号" +
                            id + " (等待竞拍)" + "</a>"
                    } else if (state == '2') {
                        str +=
                            "<a  onclick=\" setID('" + id +
                            "'); show('pay') \" class='list-group-item list-group-item-action list-group-item-light'> 编号" +
                            id + " (等待偿还)" + "</a>"
                    } else if (state == '3') {
                        str +=
                            "<a onclick=\"setID('" + id +
                            "') ; show('finished');\" class='list-group-item list-group-item-action list-group-item-success'> 编号" +
                            id + " (完成)" + "</a>"
                    } else if (state == '4') {
                        str +=
                            "<a onclick=\"setID('" + id +
                            "'); show('finished');\" class='list-group-item list-group-item-action list-group-item-danger'> 编号" +
                            id + " (未成功)" + "</a>"
                    }
                }
                str +=
                    "<a onclick=\" setID(Math.floor (Math.random() * 100000 )); show('guar');\" class='list-group-item list-group-item-action list-group-item-info'>" +
                    '为新借贷提供担保' + "</a>"
                $("#lend_ids").html(str);
            });

        }

        show('start');
    </script>
</body>

</html>
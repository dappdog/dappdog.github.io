<!doctype html>
<html>

<head>
    <meta charset=utf-8>
    <!--link rel=stylesheet href=css/style.css-->
    <meta name=viewport content="width=device-width">
    <link rel=stylesheet href=lib/bootstrap-4.0.0-dist/css/bootstrap.min.css>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script src=lib/jquery-3.3.1.min.js></script>
    <script src=lib/bootstrap-4.0.0-dist/js/bootstrap.bundle.min.js data-depends=jquery.slim></script>
    <script src=lib/bootbox.min.js data-depends="bootstrap jquery.slim"></script>
    <script src=lib/blockies.min.js></script>
    <script src=lib/js-beautify-1.7.5/beautify.js></script>
    <script src=lib/prismjs-1.13.0/prism.js></script>
    <script src=lib/nebulas.js></script>
    <script src=js/1-localSave.js></script>
    <script src=js/home.v1.js></script>
    <script src=js/i18n.js data-depends=jquery.slim></script>
    <script src=js/ui-block.js data-depends="bootbox blockies jquery.slim i18n.js nebulas.js"></script>
    <script src=lib/codemirror/codemirror.js></script>
    <script src=lib/codemirror/javascript.js></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <style>/* Move down content because we have a fixed navbar that is 3.5rem tall */

    </style>
    <title>Poll</title>
</head>

<body>

    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <p class="navbar-brand">星云选举</p>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item"><a class="nav-link" href="#" id="page_list">查看列表</a></li>
                <li class="nav-item"><a class="nav-link" href="#" id="page_new">新建选举</a></li>
            </ul>
        </div>
    </nav>
    <main role="main">
        <div class="jumbotron container">
            <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#demo"> <h4>使用说明</h4> </button>
            <div id="demo" class="container collapse">
                <br>
                <p>这是一个选举应用，用户可以进行的操作包括新建一个选举、查看当前所有选举、参与一个选举。</p>
            </div>
        </div>

        <div class=container id="page_content">
        </div>
    </main>

    <footer class="container">
        <div class="footer-copyright text-center py-3">Copyright © 2018 DAppDog 工作室</div>
        <div class="footer-copyright text-center py-3">友情链接：
            <a href="https://nebulas.io" target="_blank">星云链</a>，
            <a href="https://explorer.nebulas.io/#/" target="_blank">星云浏览器</a>，
            <a href="https://atlasp.io" target="_blank">ATP</a>
        </div>
    </footer>


    <script>
        "use strict";

        var nebulas = require("nebulas"),
            neb = new nebulas.Neb(),
            globalParams = {
                account: null
            };


        //localSave.setItem("apiPrefix", "https://testnet.nebulas.io");
        localSave.setItem("apiPrefix", "https://mainnet.nebulas.io");


        neb.setRequest(new nebulas.HttpRequest(localSave.getItem("apiPrefix") || "https://testnet.nebulas.io/"));

        //globalParams.contract_addr = "n1mPZKrJGBAwmWYZ1ktGhkTNZLqdgvwX1K6";
        globalParams.contract_addr = "n1xmdY3SyRqCyk2JJXM7g5L2BxnJbArHp9z";

        $("#page_list").on('click', function(e) {
            refresh();
            show_detail();
        })

        $("#page_new").on('click', function(e) {
            clearInterval(globalParams.refresh_interval);
            $('#page_content').empty()
            var txt1="<p> 请输入您的投票主题：</p>";               // 以 HTML 创建新元素
            var title = '<input type="text" id="poll_title"  value="你更喜欢三国里的哪个？" />'

            var txt2=$("<p> </p>").text("请输入您的投票时限（区块个数）.");   // 以 jQuery 创建新元素
            var expire = '<input type="number" id="expire"  value="1000" />'

            var txt3=$("<p> </p>").text("请输入您的选项个数.");   // 以 jQuery 创建新元素
            var cnt = '<input type="number" id="poll_cnt"  value="3" />'

            var button = '<div><button id="submit_title" class="btn btn-block">下一步</button></div>'
            $("#page_content").append(txt1, title, txt2, expire, txt3, cnt, button);         // 追加新元素

            $('#submit_title').on('click', function(e) {
                var cnt = parseInt($('#poll_cnt').val());
                var txt3=$("<p></p>").text("请输入您的各个选项内容:");   // 以 jQuery 创建新元素
                $("#page_content").append(txt3);
                for (var i = 0; i < cnt; i++)
                {
                    var content = 'alter' + i;
                    if (i == 0)
                        content = '魏';
                    else if (i == 1)
                        content = '蜀';
                    else if (i == 2)
                        content = '吴';
                    var alter = '<input id=alter'+i+' value='+content+'>';
                    $('#page_content').append(alter);
                    $('#page_content').append('<br>');
                }
                var submit_poll = '<button id="submit_poll" class="btn btn-block">确定</>'
                $('#page_content').append(submit_poll);
                $('#submit_poll').on('click', function(e) {
                    var title = $('#poll_title').val();
                    var alters = []
                    var cnt = parseInt($('#poll_cnt').val());
                    var expire = parseInt($('#expire').val())

                    for (var i = 0; i < cnt; i++)
                    {
                        var alter = $('#alter'+i).val()
                        alters.push(alter);
                    }

                    var payload = {'title': title, 'alters': alters, 'expire': expire}

                    var _to_addr = globalParams.contract_addr;
                    var _value = "0";

                    console.log(JSON.stringify([title, alters, expire]))
                    var _args = JSON.stringify([title, alters, expire]);
                    console.log(_args);
                    sendTx(_to_addr, _value, "set_poll", _args);
                });
            });
        });

        function refresh(){
            var _to_addr = globalParams.contract_addr;
            var _value = "0";

            var _args = "";
			console.log(_args);

            inner_call(_to_addr, _value, "get_all", _args, function(resp){
                var res_ = JSON.parse(JSON.parse(resp['result']));

                $('#page_content').empty()

                for (var i = res_.length - 1; i >= 0; --i) {
                    console.log(res_[i], res_[i]['alters']);

                    var poll_ = '';

                    poll_ += '<li>' + i + '</li>';

                    var res = res_[i];

                    var title = (res)['title'];
                    var alters = (res)['alters'];
                    console.log(alters)
                    poll_ += '<p>' + title + '</p>';

                    var radio = '<div>'
                    for (var i_ = 0; i_ < alters.length; ++i_) {
                        radio += '<input type="radio" name="radio" id=alter'+alters[i_]+
                            ' value='+ alters[i_] + '><label for='+alters[i_]+'>'+
                            alters[i_]+'</label><br>'
                    }

                    radio += '</div>'

                    poll_ += radio;

                    var form_group = '<div class= "form-group row">';
                    form_group += '<div class = col> <button id="button_vote_'+ i +'" class="btn btn-block" value='+ i + '> 参与投票 </button></div>';
                    form_group += '<div class = col> <button id="button_check_'+ i +'" class="btn btn-block" value='+ i + '> 查看状态 </button></div>';
                    form_group += '</div>';
                    poll_ += form_group;

                    $('#page_content').append('<div style="background-color: #f2ffd0">' + poll_ + '</div>');

                    $('#button_vote_'+i).on('click', function(e) {
                        var id = parseInt(e.target.value);
                        var alter = $('input[type="radio"][name="radio"]:checked').val(); // 获取一组radio被选中项的值

                        var _to_addr = globalParams.contract_addr;
                        var _value = "0";
                        console.log(JSON.stringify([id, alter]))
                        var _args = JSON.stringify([id, alter]);
                        console.log(_args);
                        sendTx(_to_addr, _value, "vote", _args);
                    });

                    $("#button_check_"+i).on('click', function(e) {
                        clearInterval(globalParams.refresh_interval);
                        var id = parseInt(e.target.value);
                        $('#page_content').empty()
                        var _to_addr = globalParams.contract_addr;
                        var _value = "0";

                        var _args = make_params([id]);

                        inner_call(_to_addr, _value, "detail", _args, function(resp){
                            console.log(resp['result']);
                            let res = JSON.parse(JSON.parse(resp['result']));
                            console.log(res);

                            var json = {};
                            json.chart = {type:'column'};
                            json.title = {text:res['title']};
                            json.xAxis = {categories: res['alters'],
                                title:{text: '选项'}};
                            json.yAxis = {min:0, tickInterval:1, title:{text:'票数'}};
                            json.legend = {enable: true}
                            var cnts = []
                            for (let i = 0; i < res['alters'].length; ++i) {
                                var alter = res['alters'][i];
                                if (res['dist'][alter] == null)
                                    cnts.push([alter, 0]);
                                else
                                    cnts.push([alter, res['dist'][alter]]);
                            }
                            json.series = [{
                                showInLegend: false,
                                data: cnts
                            }];

                            $("#page_content").highcharts(json);
                        })
                    });
                }

				if (window.webExtensionWallet == null) {
					$(".wallet").hide();
					$(".no-wallet").html(
						"<p> <br/> <a href='https://github.com/ChengOrangeJu/WebExtensionWallet' target='_blank'>点击安装星云官方钱包插件</a>，与智能合约交互！ :) </p>"
					);
				}
            });
        }

        function show_detail() {
            if (globalParams.refresh_interval) {
                clearInterval(globalParams.refresh_interval);
            }
            globalParams.refresh_interval = setInterval(function () {
                refresh();
            }, 15000);
        }

       document.addEventListener("DOMContentLoaded", function () {
            // Wait till the browser is ready to render the game (avoids glitches)
            window.requestAnimationFrame(function () {
                refresh();
                show_detail();
            });
        });

        window.addEventListener('message', function (e) {
            console.log("message received, msg.data: " + JSON.stringify(e.data));
            if (!!e.data.data && !!e.data.data.txhash) {
                if ($(".modal.tips").is(':visible')) {
                    $(".modal.tips").modal('toggle');
                }
            }
        });

        function sendTx(_to_addr, _value, _func, _args) {
            window.postMessage({
                "target": "contentscript",
                "data": {
                    "to": _to_addr,
                    "value": _value.toString(),
                    "contract": {
                        "function": _func,
                        "args": _args
                    }
                },
                "method": "neb_sendTransaction",
            }, "*");
        }

        function inner_call(_to_addr, _value, _func, _args, callback) {
            var url = 'https://mainnet.nebulas.io/v1/user/call';
            var from = 'n1YeD6SCiSNxjQ1CEUhSpThNxPU77mvB1sp';

            if (localSave.getItem("apiPrefix").includes('test')) {
                url = 'https://testnet.nebulas.io/v1/user/call';
                from = 'n1cNkcUumVmt6CHjYhgTECZHnm3nGDzkWfx';
            }

            var contract = _to_addr;

            var requestObj = {
                from: from,
                to: contract,
                value: _value,
                nonce: 111112888,
                gasPrice: '1000000',
                gasLimit: '200000000',
                contract: {
                    function: _func,
                    args: _args
                }
            };
			
			console.log(requestObj);
			
            fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestObj)
                })
                .then(res => res.json())
                .then(res => {
                    callback(res['result']);
                });
        }
    </script>
</body>
</html>